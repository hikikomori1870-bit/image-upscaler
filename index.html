const coreProcessor = new Upscaler(); 
const fileInput = document.getElementById('imageInput');
const runBtn = document.getElementById('processBtn');
const inputImg = document.getElementById('inputPreview');
const outputImg = document.getElementById('outputResult');
const loader = document.getElementById('loading');
const saveLink = document.getElementById('downloadBtn');
const engineMsg = document.getElementById('engine-status');
const statusText = document.getElementById('status-text');
coreProcessor.getModel().then(() => {
    engineMsg.innerText = "Hệ thống: Đã kích hoạt thuật toán Render.";
    engineMsg.style.color = "#a1c4fd";
});
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            inputImg.src = event.target.result;
            runBtn.disabled = false;
            outputImg.classList.add('hidden');
            saveLink.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }
});
runBtn.addEventListener('click', async () => {
    loader.classList.remove('hidden');
    outputImg.classList.add('hidden');
    runBtn.disabled = true;

    try {
        const renderedData = await coreProcessor.upscale(inputImg.src, {
            patchSize: 64,
            padding: 5,
            progress: (p) => {
                const percent = Math.round(p * 100);
                statusText.innerText = `Đang tái cấu trúc: ${percent}%`;
            }
        });
        outputImg.src = renderedData;
        outputImg.classList.remove('hidden');
        
        saveLink.href = renderedData;
        saveLink.download = "PhotoSharper_Enhanced.png";
        saveLink.classList.remove('hidden');
    } catch (err) {
        alert("Lỗi xử lý: Dữ liệu hình ảnh không phù hợp với thuật toán.");
    } finally {
        loader.classList.add('hidden');
        runBtn.disabled = false;
    }
});
